name: Publish to PowerShell Gallery

on:
  # Manual trigger with optional force parameter
  workflow_dispatch:
    inputs:
      force:
        description: 'Force publication even if version already exists'
        required: false
        default: false
        type: boolean

  # Automatic trigger on release
  release:
    types: [published]

jobs:
  publish:
    name: Publish Module
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "üîß PowerShell Version: $($PSVersionTable.PSVersion)" -ForegroundColor Cyan
          Write-Host "üîß OS: $($PSVersionTable.OS)" -ForegroundColor Cyan

      - name: Build Module
        shell: pwsh
        run: |
          Write-Host "üî® Building module..." -ForegroundColor Yellow
          ./build.ps1 -AutoRestore -Tasks build
          Write-Host "‚úÖ Build completed" -ForegroundColor Green

      - name: Find and Validate Module
        id: validate
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # Define base paths
          $BaseModulePath = Join-Path $env:GITHUB_WORKSPACE "output/module/PSWimToolkit"

          Write-Host "üîç Finding latest module version..." -ForegroundColor Yellow
          $versionDirs = Get-ChildItem -Path $BaseModulePath -Directory | Where-Object { $_.Name -match '^\d+\.\d+\.\d+$' }

          if (-not $versionDirs) {
              Write-Error "No version directories found in $BaseModulePath"
              exit 1
          }

          $latestVersionDir = ($versionDirs | Sort-Object { [Version]$_.Name } -Descending)[0]
          $ModulePath = $latestVersionDir.FullName
          $ManifestPath = Join-Path $ModulePath "PSWimToolkit.psd1"

          Write-Host "üîç Detected version: $($latestVersionDir.Name)" -ForegroundColor Cyan
          Write-Host "üìÇ Module path: $ModulePath" -ForegroundColor Cyan

          # Validate manifest
          Write-Host "üìã Validating module manifest..." -ForegroundColor Yellow
          $manifest = Test-ModuleManifest -Path $ManifestPath -ErrorAction Stop
          Write-Host "‚úÖ Manifest valid - Version: $($manifest.Version)" -ForegroundColor Green

          # Export variables for next steps
          "MODULE_PATH=$ModulePath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "MODULE_VERSION=$($manifest.Version)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Check PowerShell Gallery Version
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'

          Write-Host "üîç Checking PowerShell Gallery versions..." -ForegroundColor Yellow

          try {
              $existingVersions = Find-Module -Name PSWimToolkit -Repository PSGallery -AllVersions -ErrorAction SilentlyContinue

              if ($existingVersions) {
                  $galleryLatest = ($existingVersions | Sort-Object Version -Descending)[0].Version
                  Write-Host "üì¶ Latest version in gallery: $galleryLatest" -ForegroundColor Cyan
                  Write-Host "üì¶ Version to publish: $env:MODULE_VERSION" -ForegroundColor Cyan

                  if ([Version]$galleryLatest -ge [Version]$env:MODULE_VERSION) {
                      if ('${{ github.event.inputs.force }}' -ne 'true') {
                          Write-Warning "Version $env:MODULE_VERSION is not greater than existing version $galleryLatest"
                          Write-Host "üí° Use workflow_dispatch with force=true to override" -ForegroundColor Magenta
                          exit 1
                      } else {
                          Write-Host "‚ö†Ô∏è Force flag enabled, proceeding with publication..." -ForegroundColor Yellow
                      }
                  }
              } else {
                  Write-Host "üì¶ No existing versions found in gallery (first publish)" -ForegroundColor Cyan
              }
          }
          catch {
              Write-Warning "Could not check existing versions: $($_.Exception.Message)"
              Write-Host "Proceeding with publication attempt..." -ForegroundColor Yellow
          }

      - name: Publish to PowerShell Gallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.API_KEY }}
        run: |
          $ErrorActionPreference = 'Stop'

          if (-not $env:PSGALLERY_API_KEY) {
              Write-Error "API_KEY secret is not set. Please add it to your repository secrets."
              exit 1
          }

          Write-Host "üì§ Publishing to PowerShell Gallery..." -ForegroundColor Yellow
          Write-Host "Module: PSWimToolkit v$env:MODULE_VERSION" -ForegroundColor Cyan
          Write-Host "Path: $env:MODULE_PATH" -ForegroundColor Cyan

          # Prepare publish parameters
          $publishParams = @{
              Path       = $env:MODULE_PATH
              Repository = 'PSGallery'
              Verbose    = $true
          }

          # Check which publish command is available
          if (Get-Command 'Publish-PSResource' -ErrorAction SilentlyContinue) {
              Write-Host "Using Publish-PSResource..." -ForegroundColor Cyan
              $publishParams.ApiKey = $env:PSGALLERY_API_KEY
              Publish-PSResource @publishParams
          } else {
              Write-Host "Using Publish-Module..." -ForegroundColor Cyan
              $publishParams.NuGetApiKey = $env:PSGALLERY_API_KEY
              Publish-Module @publishParams
          }

          Write-Host ""
          Write-Host "üéâ SUCCESS! PSWimToolkit v$env:MODULE_VERSION published!" -ForegroundColor Green
          Write-Host "=================================" -ForegroundColor Green
          Write-Host "üì¶ Installation command:" -ForegroundColor Cyan
          Write-Host "Install-Module -Name PSWimToolkit -RequiredVersion $env:MODULE_VERSION" -ForegroundColor White
          Write-Host ""
          Write-Host "‚è∞ Note: It may take a few minutes for the new version to appear in search results." -ForegroundColor Yellow

      - name: Verify Publication
        shell: pwsh
        run: |
          Write-Host "üîç Waiting for gallery to update..." -ForegroundColor Yellow
          Start-Sleep -Seconds 30

          try {
              $published = Find-Module -Name PSWimToolkit -Repository PSGallery -ErrorAction SilentlyContinue
              if ($published) {
                  Write-Host "‚úÖ Module found in gallery: PSWimToolkit v$($published.Version)" -ForegroundColor Green
              } else {
                  Write-Host "‚è∞ Module not yet visible in gallery search. This is normal - it may take a few minutes." -ForegroundColor Yellow
              }
          }
          catch {
              Write-Host "‚è∞ Could not verify publication yet. Check manually at:" -ForegroundColor Yellow
              Write-Host "https://www.powershellgallery.com/packages/PSWimToolkit" -ForegroundColor Cyan
          }
